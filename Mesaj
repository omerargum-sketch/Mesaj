<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Özel Online Sohbet</title>
  <style>
    body { font-family: Arial; background: #f0f0f0; margin:0; display:flex; flex-direction:column; align-items:center; }
    #login { margin-top:50px; text-align:center; }
    #chatContainer { display:none; width:95%; max-width:900px; margin-top:20px; display:flex; flex-direction:row; }
    #friends { width:25%; background:#fff; border:1px solid #ccc; padding:10px; height:600px; overflow-y:auto; margin-right:10px; border-radius:8px; }
    #friends input { width:100%; margin-bottom:10px; padding:5px; border-radius:4px; border:1px solid #ccc; }
    #friendList .friend { padding:8px; cursor:pointer; border-bottom:1px solid #eee; border-radius:4px; margin-bottom:2px; }
    #friendList .friend:hover { background:#f0f0f0; }
    #messages { width:75%; background:#fff; border:1px solid #ccc; padding:10px; height:600px; display:flex; flex-direction:column; border-radius:8px; }
    #messageList { overflow-y:auto; flex:1; padding-right:5px; }
    .message { border-bottom:1px solid #eee; padding:5px; margin-bottom:5px; border-radius:6px; }
    .message b { margin-right:5px; }
    .message .timestamp { font-size:0.7em; color:#888; margin-left:5px; }
    .media { margin-top:5px; }
    #messageBox { display:flex; margin-top:auto; }
    #messageBox input[type="text"] { flex:1; padding:5px; border-radius:4px; border:1px solid #ccc; }
    #messageBox input[type="file"] { margin-left:5px; }
    #messageBox button { padding:5px 10px; margin-left:5px; border-radius:4px; cursor:pointer; }
    @media(max-width:768px){
      #chatContainer { flex-direction:column; }
      #friends { width:100%; margin-bottom:10px; }
      #messages { width:100%; height:500px; }
    }
  </style>
</head>
<body>

<div id="login">
  <h2>Hoşgeldin! İsmini gir:</h2>
  <input type="text" id="usernameInput" placeholder="İsminizi yazın">
  <button onclick="login()">Giriş Yap</button>
</div>

<div id="chatContainer">
  <div id="friends">
    <input type="text" id="friendSearch" placeholder="Arkadaş ekle / ara" oninput="searchFriend()">
    <div id="friendList"></div>
  </div>
  <div id="messages">
    <div id="messageList"></div>
    <div id="messageBox">
      <input type="text" id="msgInput" placeholder="Mesaj yaz...">
      <input type="file" id="fileInput">
      <button onclick="sendMessage()">Gönder</button>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<script>
  // Senin Firebase config bilgilerini buraya yapıştır
  const firebaseConfig = {
    apiKey: "AIzaSyD_cs9ke1f3u-bodte79PjensJ_hQDq6W8",
    authDomain: "mesaj-c7ccf.firebaseapp.com",
    databaseURL: "https://mesaj-c7ccf-default-rtdb.europe-west1.firebasedatabase.app/",
    projectId: "mesaj-c7ccf",
    storageBucket: "mesaj-c7ccf.appspot.com",
    messagingSenderId: "340320092127",
    appId: "1:340320092127:web:9846087a6a1aad4f774e6a"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const storage = firebase.storage();

  let currentUser = '';
  let friends = [];
  let activeFriend = '';

  function login() {
    const name = document.getElementById('usernameInput').value.trim();
    if(name === '') return alert('İsim boş olamaz!');
    currentUser = name;
    document.getElementById('login').style.display = 'none';
    document.getElementById('chatContainer').style.display = 'flex';
    db.ref('users/'+currentUser).set(true);
    loadFriends();
  }

  function loadFriends() {
    db.ref('users').on('value', snapshot => {
      friends = [];
      snapshot.forEach(child => {
        const uname = child.key;
        if(uname !== currentUser) friends.push(uname);
      });
      displayFriends();
    });
  }

  function displayFriends(filter='') {
    const friendList = document.getElementById('friendList');
    friendList.innerHTML = '';
    friends.filter(f=>f.toLowerCase().includes(filter.toLowerCase())).forEach(f => {
      const div = document.createElement('div');
      div.textContent = f;
      div.className = 'friend';
      div.onclick = ()=> selectFriend(f);
      friendList.appendChild(div);
    });
  }

  function searchFriend() {
    const val = document.getElementById('friendSearch').value;
    displayFriends(val);
    if(val && !friends.includes(val) && val !== currentUser) {
      db.ref('users/'+val).set(true);
    }
  }

  function selectFriend(friendName) {
    activeFriend = friendName;
    loadMessages();
  }

  function sendMessage() {
    if(!activeFriend) return alert('Önce arkadaş seç!');
    const msgText = document.getElementById('msgInput').value;
    const file = document.getElementById('fileInput').files[0];
    if(msgText === '' && !file) return;

    const msgKey = db.ref('messages').push().key;
    const msgData = { from: currentUser, to: activeFriend, text: msgText, timestamp: Date.now() };

    if(file) {
      const storageRef = storage.ref('files/'+msgKey+'_'+file.name);
      storageRef.put(file).then(() => {
        storageRef.getDownloadURL().then(url=>{
          msgData.file = { name: file.name, url: url };
          db.ref('messages/'+msgKey).set(msgData);
        });
      });
    } else {
      db.ref('messages/'+msgKey).set(msgData);
    }

    document.getElementById('msgInput').value = '';
    document.getElementById('fileInput').value = '';
  }

  function loadMessages() {
    if(!activeFriend) return;
    const messageList = document.getElementById('messageList');
    messageList.innerHTML = '';
    db.ref('messages').on('value', snapshot => {
      messageList.innerHTML = '';
      snapshot.forEach(child => {
        const msg = child.val();
        if((msg.from===currentUser && msg.to===activeFriend) || (msg.to===currentUser && msg.from===activeFriend)) {
          const div = document.createElement('div');
          div.className = 'message';
          const time = new Date(msg.timestamp).toLocaleTimeString();
          div.innerHTML = `<b>${msg.from}</b> <span class="timestamp">${time}</span>: ${msg.text || ''}`;
          if(msg.file) {
            const fileDiv = document.createElement('div');
            fileDiv.className = 'media';
            fileDiv.innerHTML = `<a href="${msg.file.url}" download="${msg.file.name}">${msg.file.name}</a>`;
            div.appendChild(fileDiv);
          }
          messageList.appendChild(div);
        }
      });
      messageList.scrollTop = messageList.scrollHeight;
    });
  }
</script>

</body>
</html>
